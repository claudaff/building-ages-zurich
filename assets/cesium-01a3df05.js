const I="./arch_zones_with_count.geojson",k="./zurich_districts_lines.geojson";let g,w=!1,f,E,p;const M=[1850,1875,1900,1925,1950,1960,1970,1980,1990,2e3,2020],O=["#040001","#0B0000","#1B0000","#360402","#8C0F09","#DC4511","#E08226","#47B5F9","#112C3E","#001D3E","#002506"],_=document.getElementById("years"),D=document.getElementById("year"),R=document.getElementById("toggleArchZones");D.addEventListener("input",A);R.addEventListener("click",j);A.call(D);viewer.clock.currentTime=Cesium.JulianDate.fromIso8601("2023-07-01T14:00:00+02:00");const N=new Date,x=N.getFullYear();viewer.animation.container.style.visibility="hidden";viewer.timeline.container.style.visibility="hidden";viewer.scene.globe.depthTestAgainstTerrain=!0;const B=new Cesium.Credit('<a href="https://www.swisstopo.admin.ch/en/geodata/landscape/tlm3d.html" target="_blank">Federal Office of Topography swisstopo</a> | <a href="https://maps.zh.ch/" target="_blank">GIS Zürich</a> | <a href="https://www.stadt-zuerich.ch/geodaten/download/87" target="_blank">Stadt Zürich Geodaten</a>',!0);viewer.creditDisplay.addStaticCredit(B);viewer._cesiumWidget._creditContainer.style.left="55%";viewer._cesiumWidget._creditContainer.style.bottom="0%";(async()=>{viewer.scene.setTerrain(new Cesium.Terrain(Cesium.CesiumTerrainProvider.fromUrl("https://terrain3.geo.admin.ch/1.0.0/ch.swisstopo.terrain.3d/default/20200520/4326")));const e=new Cesium.WebMapServiceImageryProvider({url:"https://wms.geo.admin.ch/?",layers:"ch.swisstopo.swissimage",minimumLevel:8,maximumLevel:17,tilingScheme:new Cesium.GeographicTilingScheme({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1}),rectangle:Cesium.Rectangle.fromDegrees(5.013926957923385,45.35600133779394,11.477436312994008,48.27502358353741)}),i=new Cesium.ImageryLayer(e);i.saturation=.5,viewer.imageryLayers.add(i);const t=viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(8.538,47.285,6e3),point:{pixelSize:10,color:Cesium.Color.TRANSPARENT,outlineColor:Cesium.Color.TRANSPARENT,outlineWidth:0}});await viewer.zoomTo(t)&&(viewer.flyTo(t,{duration:3,offset:{heading:0,pitch:Cesium.Math.toRadians(-30)}}),setTimeout(()=>{_.style.display="block"},5e3)),Cesium.GeoJsonDataSource.load(k,{maximumScreenSpaceError:1,clampToGround:!0,stroke:Cesium.Color.fromCssColorString("rgba(255, 0, 0, 0.5)"),strokeWidth:1}).then(function(s){viewer.dataSources.add(s),E=s});const c=[10,100,200,800,1e3],m=[.1,.3,.5,.7,.8];Cesium.GeoJsonDataSource.load(I,{clampToGround:!0,strokeWidth:0,stroke:Cesium.Color.TRANSPARENT}).then(function(s){p=s,p.entities.values.forEach(r=>{const u=r.properties.NUMPOINTS;let a=1;for(let d=0;d<c.length;d++)if(u<=c[d]){a=m[d];break}r.polygon.material=Cesium.Color.fromCssColorString(`rgba(139, 69, 0, ${a})`),viewer.dataSources.add(p),p.show=!1})});try{g=await Cesium.Cesium3DTileset.fromUrl("https://vectortiles0.geo.admin.ch/3d-tiles/ch.swisstopo.swisstlm3d.3d/20201020/tileset.json",{maximumScreenSpaceError:6,distanceskipLevelOfDetail:!0,baseScreenSpaceError:1024,skipScreenSpaceErrorFactor:16,skipLevels:1,immediatelyLoadDesiredLevelOfDetail:!1,loadSiblings:!1,cullWithChildrenBounds:!0}),viewer.scene.primitives.add(g),viewer.scene.primitives.raiseToTop(g),w=!0,g.colorBlendMode=Cesium.Cesium3DTileColorBlendMode.REPLACE,g.colorBlendAmount=1;let s;f={},fetch("./uuidToAgeMap.json").then(r=>r.json()).then(r=>{s=r,s.forEach(u=>{const a=u.UUID,d=u.AGE;f[a]=d}),g.tileVisible.addEventListener(function(u){const a=u.content,d=a.featuresLength;for(let C=0;C<d;C++){const h=a.getFeature(C),P=h.getProperty("UUID");f[P]<=1850?h.color=Cesium.Color.fromCssColorString("#040001"):h.color=Cesium.Color.TRANSPARENT}})}).catch(r=>console.error("Error loading JSON:",r))}catch(s){console.error("Error loading Cesium3DTileset:",s)}w&&console.log("swissTLMTileset has been initialized")})();const z=2e3,n=(e,i,t)=>({position:Cesium.Cartesian3.fromDegrees(e,i,z),image:`./piecharts/pie_chart_district_${t}.png`,scale:.2,name:`Kreis ${t}`}),U=[n(8.541,47.372,1),n(8.526,47.342,2),n(8.506,47.359,3),n(8.517,47.381,4),n(8.523,47.388,5),n(8.546,47.392,6),n(8.582,47.369,7),n(8.558,47.353,8),n(8.481,47.381,9),n(8.502,47.405,10),n(8.527,47.419,11),n(8.574,47.402,12)];let S,b,y,v;const o=document.createElement("div");viewer.container.appendChild(o);o.className="backdrop";o.style.display="none";o.style.position="absolute";o.style.bottom="0";o.style.left="0";o.style["pointer-events"]="none";o.style.padding="4px";o.style.backgroundColor="black";o.style.color="white";o.style.borderRadius="1em";function W(e,i){if(!Cesium.defined(e)){o.style.display="none";return}if(e instanceof Cesium.Cesium3DTileFeature)o.style.display="block",o.style.bottom=`${viewer.canvas.clientHeight-i.y}px`,o.style.left=`${i.x}px`,S=e.getProperty("UUID"),y=f[S],b=x-y,o.innerHTML=`Construction Year: ${y}<br>Building Age: ${b} years old`;else if(!(e.primitive instanceof Cesium.Billboard)&&!(e.primitive instanceof Cesium.Label)){try{v=e.id.properties.NUMPOINTS._value}catch{console.log("Feature has no attribute NUMPOINTS")}Cesium.defined(v)&&(o.style.display="block",o.style.bottom=`${viewer.canvas.clientHeight-i.y}px`,o.style.left=`${i.x}px`,o.innerHTML=`Archeological Zone<br>containing ${v} buildings<br> as of 2020`)}}const $={feature:void 0,originalColor:new Cesium.Color};if(Cesium.PostProcessStageLibrary.isSilhouetteSupported(viewer.scene)){const e=Cesium.PostProcessStageLibrary.createEdgeDetectionStage();e.uniforms.color=Cesium.Color.WHITE,e.uniforms.length=.01,e.selected=[],viewer.scene.postProcessStages.add(Cesium.PostProcessStageLibrary.createSilhouetteStage([e])),viewer.screenSpaceEventHandler.setInputAction(function(t){e.selected=[];const l=viewer.scene.pick(t.endPosition);W(l,t.endPosition),Cesium.defined(l)&&l!==$.feature&&(e.selected=[l])},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}const G=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);let L,T=!1;G.setInputAction(e=>{const i=viewer.scene.pick(e.position);if(Cesium.defined(i)&&Cesium.defined(i.primitive)&&i.primitive instanceof Cesium.Billboard&&!T){T=!0;const t=i.primitive.position,l=i.primitive.id.name;let c,m=Cesium.Cartographic.fromCartesian(t),s=Cesium.Math.toDegrees(m.longitude),r=Cesium.Math.toDegrees(m.latitude);c=Cesium.Cartesian3.fromDegrees(s,r,500),Cesium.defined(t)&&Z(l,c,t)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);async function A(){let e;e=this.value;const i=parseInt(e,10);e={0:"1850",1:"1875",2:"1900",3:"1925",4:"1950",5:"1960",6:"1970",7:"1980",8:"1990",9:"2000",10:"2020"}[e],this.nextSibling.nextSibling.innerText=e,w&&g.tileVisible.addEventListener(function(l){const c=l.content,m=c.featuresLength;for(let s=0;s<m;s++){const r=c.getFeature(s);r.color=Cesium.Color.TRANSPARENT;const u=r.getProperty("UUID"),a=f[u],d=i+1;for(let C=0;C<d;C++)if(a<=M[C]){r.color=Cesium.Color.fromCssColorString(O[C]);break}}}),H(i)}function H(e){e==0?viewer.entities.removeAll():(viewer.entities.removeAll(),U.forEach((i,t)=>{viewer.entities.add({position:i.position,billboard:{image:`./piecharts/kreis${t+1}/piechart_kreis_${t+1}_${e}.png`,scale:i.scale},label:{text:i.name,font:"14px sans-serif",show:!0,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,pixelOffset:new Cesium.Cartesian2(0,-40)},name:i.name})}))}function j(){let e=p.show;p.show=!e}function Z(e,i,t){const l=new Cesium.Ray(t,new Cesium.Cartesian3(0,0,-1)),c=viewer.scene.globe.pick(l,viewer.scene);let m=Cesium.JulianDate.now();Cesium.defined(c)&&(L=viewer.entities.add({polyline:{positions:new Cesium.CallbackProperty(()=>{let s=Cesium.JulianDate.now(),r=Cesium.JulianDate.secondsDifference(s,m),u=Cesium.Math.clamp(r/2,0,1),a=Cesium.Cartesian3.lerp(t,i,u,new Cesium.Cartesian3);return[t,a]},!1),width:5,material:new Cesium.PolylineOutlineMaterialProperty({color:Cesium.Color.WHITESMOKE,outlineWidth:2,outlineColor:Cesium.Color.GRAY})}}),setTimeout(()=>{J(e)},2e3))}function J(e){viewer.entities.remove(L),E.entities.values.forEach(i=>{let t=parseInt(i.properties.name);t=t.toString(),e.includes(t)&&(t=="1"&&e=="Kreis 10"||t=="1"&&e=="Kreis 11"||t=="1"&&e=="Kreis 12"||t=="2"&&e=="Kreis 12"||(i.polyline.material=Cesium.Color.fromCssColorString("rgba(255, 0, 0, 1)"),i.polyline.width=3,i.polyline.outlineColor=Cesium.Color.fromCssColorString("rgba(255, 255, 255, 1)"),i.polyline.outlineWidth=2,setTimeout(()=>{i.polyline.material=Cesium.Color.fromCssColorString("rgba(255, 0, 0, 0.5)"),i.polyline.width=1,i.polyline.outlineColor=Cesium.Color.TRANSPARENT,i.polyline.outlineWidth=0,T=!1},1500)))})}
